<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Amazement - Admin Panel</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@500&family=Poppins:wght@400;500&display=swap" rel="stylesheet">
    <style>
        .admin-container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 2rem;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 20px;
            backdrop-filter: blur(10px);
        }
        
        .admin-section {
            margin-bottom: 3rem;
            padding: 2rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .admin-section h2 {
            color: #FFD700;
            margin-bottom: 1.5rem;
            font-size: 1.8rem;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #fff;
            font-weight: 500;
        }
        
        .form-group input, .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-family: 'Poppins', sans-serif;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        .form-group input:focus, .form-group textarea:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.15);
            box-shadow: 0 0 15px #FFD70044;
        }
        
        .form-group textarea {
            min-height: 120px;
            resize: vertical;
        }
        
        .save-btn {
            background: linear-gradient(90deg, #FFD700 0%, #FFB300 100%);
            color: #111;
            border: none;
            border-radius: 30px;
            padding: 12px 30px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .save-btn:hover {
            background: linear-gradient(90deg, #FFB300 0%, #FFD700 100%);
            box-shadow: 0 4px 20px #FFD70088;
        }
        
        .preview {
            margin-top: 1rem;
            padding: 1rem;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .preview img {
            max-width: 200px;
            height: auto;
            border-radius: 10px;
        }
        
        .success-message {
            background: rgba(0, 255, 0, 0.2);
            color: #90EE90;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
            display: none;
        }
        
        .error-message {
            background: rgba(255, 0, 0, 0.2);
            color: #FFB6C1;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
            display: none;
        }
        
        .video-input-group {
            display: flex;
            gap: 1rem;
            align-items: end;
        }
        
        .video-input-group .form-group {
            flex: 1;
        }
        
        .remove-video-btn {
            background: rgba(255, 0, 0, 0.3);
            color: #FFB6C1;
            border: none;
            border-radius: 5px;
            padding: 8px 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .remove-video-btn:hover {
            background: rgba(255, 0, 0, 0.5);
        }
        
        .add-video-btn {
            background: rgba(0, 255, 0, 0.3);
            color: #90EE90;
            border: none;
            border-radius: 5px;
            padding: 8px 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 1rem;
        }
        
        .add-video-btn:hover {
            background: rgba(0, 255, 0, 0.5);
        }
        
        .back-home-button {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: linear-gradient(90deg, #FFD700 0%, #FFB300 100%);
            color: #111;
            text-decoration: none;
            padding: 12px 24px;
            border-radius: 30px;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 1rem;
        }
        
        .back-home-button:hover {
            background: linear-gradient(90deg, #FFB300 0%, #FFD700 100%);
            box-shadow: 0 4px 20px rgba(255, 215, 0, 0.4);
            transform: translateY(-2px);
        }
        
        .back-home-button i {
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <header>
        <div class="logo-img">
            <img src="logo.png" alt="Daily Amazement Logo">
        </div>
        <h1 style="text-align: center; color: #FFD700; margin: 1rem 0;">Admin Panel</h1>
        <p style="text-align: center; color: #fff; margin: 0.5rem 0; font-size: 1.1rem;">Hi Wippa, Ted & Jack</p>
        <div style="text-align: center; margin-top: 1rem;">
            <button onclick="logout()" style="background: rgba(255, 0, 0, 0.3); color: #FFB6C1; border: none; padding: 8px 16px; border-radius: 20px; cursor: pointer; transition: all 0.3s ease;">
                <i class="fas fa-sign-out-alt"></i>
                Logout
            </button>
        </div>
    </header>

    <div style="text-align: center; margin: 2rem auto 1rem; max-width: 800px;">
        <a href="index.html" class="back-home-button">
            <i class="fas fa-arrow-left"></i>
            Back to Home Page
        </a>
    </div>

    <div class="admin-container">
        <!-- Prize Image Section -->
        <div class="admin-section">
            <h2><i class="fas fa-image"></i> Update Prize Image</h2>
            
            <!-- File Upload Option -->
            <div class="form-group">
                <label for="imageUpload">Upload Image from Computer:</label>
                <input type="file" id="imageUpload" accept="image/*" onchange="handleImageUpload(event)">
                <p style="color: #ccc; font-size: 0.9rem; margin-top: 0.5rem;">Supported formats: JPG, PNG, GIF, WebP</p>
            </div>
            
            <div style="text-align: center; margin: 1rem 0; color: #ccc;">- OR -</div>
            
            <!-- URL Option -->
            <div class="form-group">
                <label for="prizeImageUrl">Prize Image URL:</label>
                <input type="url" id="prizeImageUrl" placeholder="https://example.com/image.jpg">
            </div>
            <div class="form-group">
                <label for="prizeImageAlt">Image Alt Text:</label>
                <input type="text" id="prizeImageAlt" placeholder="Air Jordan XXXVIII">
            </div>
            <button class="save-btn" id="updatePrizeImageBtn">Update Prize Image</button>
            <div class="preview" id="prizeImagePreview">
                <h4>Current Image:</h4>
                <img src="https://static.nike.com/a/images/f_auto/dpr_2.0,cs_srgb/h_1029,c_limit/97e43798-a15e-4c10-8ed0-df5ad5899430/jordan-brand-launches-the-air-jordan-xxxviii.jpg" alt="Current Prize">
            </div>
            <div class="success-message" id="prizeImageSuccess">Prize image updated successfully!</div>
            <div class="error-message" id="prizeImageError">Error updating prize image. Please try again.</div>
        </div>

        <!-- Prize Text Section -->
        <div class="admin-section">
            <h2><i class="fas fa-edit"></i> Update Prize Description</h2>
            <div class="form-group">
                <label for="prizeDescription">Prize Description:</label>
                <textarea id="prizeDescription" placeholder="Enter the prize description...">Inspired by the straps on the Air Jordan VIII, the Air Jordan XXXVIII sneaker will debut the X-Plate, a new plate technology that helps to keep players' feet secure over the footbed during sharp movements.

The upper features embroidered designs highlighting Michael Jordan's performance in the 1993 championship series.

The Air Jordan XXXVIII is the most sustainably made Air Jordan signature shoe in Jordan Brand history, made from at least 20 percent recycled material by weight.</textarea>
            </div>
            <button class="save-btn" id="updatePrizeDescriptionBtn">Update Prize Description</button>
            <div class="success-message" id="prizeDescriptionSuccess">Prize description updated successfully!</div>
            <div class="error-message" id="prizeDescriptionError">Error updating prize description. Please try again.</div>
        </div>

        <!-- YouTube Videos Section -->
        <div class="admin-section">
            <h2><i class="fab fa-youtube"></i> Update Featured Videos</h2>
            <p style="color: #ccc; margin-bottom: 1rem;">Enter YouTube video URLs or video IDs. The system will automatically extract video IDs from URLs.</p>
            <p style="color: #90EE90; margin-bottom: 1rem; font-size: 0.9rem;">
                <i class="fas fa-info-circle"></i> 
                <strong>Video Requirements:</strong> Main site requires exactly 3 videos, Video page shows minimum 6 videos
            </p>
            <p style="color: #FFD700; margin-bottom: 1rem; font-size: 0.9rem;">
                <i class="fas fa-exclamation-triangle"></i> 
                <strong>Note:</strong> The main site will always display exactly 3 videos. Additional videos will be used as backups.
            </p>
            <div id="videoInputs">
                <div class="video-input-group">
                    <div class="form-group">
                        <label for="video1">Video 1:</label>
                        <input type="text" id="video1" placeholder="https://www.youtube.com/watch?v=VIDEO_ID or just VIDEO_ID">
                    </div>
                    <button class="remove-video-btn" onclick="removeVideo(this)">Remove</button>
                </div>
                <div class="video-input-group">
                    <div class="form-group">
                        <label for="video2">Video 2:</label>
                        <input type="text" id="video2" placeholder="https://www.youtube.com/watch?v=VIDEO_ID or just VIDEO_ID">
                    </div>
                    <button class="remove-video-btn" onclick="removeVideo(this)">Remove</button>
                </div>
                <div class="video-input-group">
                    <div class="form-group">
                        <label for="video3">Video 3:</label>
                        <input type="text" id="video3" placeholder="https://www.youtube.com/watch?v=VIDEO_ID or just VIDEO_ID">
                    </div>
                    <button class="remove-video-btn" onclick="removeVideo(this)">Remove</button>
                </div>
            </div>
            <button class="add-video-btn" onclick="addVideoInput()">Add Another Video</button>
            <button class="save-btn" id="updateVideosBtn">Update Featured Videos</button>
            <div class="success-message" id="videosSuccess">Featured videos updated successfully!</div>
            <div class="error-message" id="videosError">Error updating videos. Please try again.</div>
        </div>

        <!-- Winner Section -->
        <div class="admin-section">
            <h2><i class="fas fa-trophy"></i> Update Winner</h2>
            <div class="form-group">
                <label for="winnerName">Winner Name:</label>
                <input type="text" id="winnerName" placeholder="John Doe">
            </div>
            <div class="form-group">
                <label for="winnerYoutube">YouTube Name:</label>
                <input type="text" id="winnerYoutube" placeholder="@ScoobyBoi78">
            </div>
            <button class="save-btn" id="updateWinnerBtn">Update Winner</button>
            <div class="success-message" id="winnerSuccess">Winner updated successfully!</div>
            <div class="error-message" id="winnerError">Error updating winner. Please try again.</div>
        </div>

        <!-- Competition Entries Overview Section -->
        <div class="admin-section">
            <h2><i class="fas fa-users"></i> Competition Entries Overview</h2>
            <p style="color: #ccc; margin-bottom: 1.5rem;">View all competition entries, participant details, and submitted codewords.</p>
            
            <!-- Entry Statistics -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                <div style="background: rgba(0, 255, 0, 0.1); padding: 1.5rem; border-radius: 10px; border: 1px solid rgba(0, 255, 0, 0.3); text-align: center;">
                    <h3 style="color: #90EE90; margin: 0; font-size: 2rem;" id="totalEntriesCount">0</h3>
                    <p style="color: #90EE90; margin: 0.5rem 0 0 0; font-weight: 500;">Total Entries</p>
                </div>
                <div style="background: rgba(255, 215, 0, 0.1); padding: 1.5rem; border-radius: 10px; border: 1px solid rgba(255, 215, 0, 0.3); text-align: center;">
                    <h3 style="color: #FFD700; margin: 0; font-size: 2rem;" id="uniqueParticipantsCount">0</h3>
                    <p style="color: #FFD700; margin: 0.5rem 0 0 0; font-weight: 500;">Unique Participants</p>
                </div>
                <div style="background: rgba(0, 191, 255, 0.1); padding: 1.5rem; border-radius: 10px; border: 1px solid rgba(0, 191, 255, 0.3); text-align: center;">
                    <h3 style="color: #00BFFF; margin: 0; font-size: 2rem;" id="uniqueCodewordsCount">0</h3>
                    <p style="color: #00BFFF; margin: 0.5rem 0 0 0; font-weight: 500;">Unique Codewords Used</p>
                </div>
            </div>

            <!-- Search and Filter -->
            <div style="margin-bottom: 1.5rem;">
                <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                    <input type="text" id="entrySearchInput" placeholder="Search by name, email, or codeword..." style="flex: 1; min-width: 250px; padding: 10px 15px; border: none; border-radius: 8px; background: rgba(255, 255, 255, 0.1); color: white; font-family: 'Poppins', sans-serif;">
                    <select id="codewordFilter" style="padding: 10px 15px; border: none; border-radius: 8px; background: rgba(255, 255, 255, 0.1); color: white; font-family: 'Poppins', sans-serif;">
                        <option value="">All Codewords</option>
                    </select>
                    <button onclick="refreshEntries()" style="background: rgba(0, 255, 0, 0.3); color: #90EE90; border: none; border-radius: 8px; padding: 10px 15px; cursor: pointer; transition: all 0.3s ease;">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
            </div>

            <!-- Entries Table -->
            <div style="background: rgba(0, 0, 0, 0.3); border-radius: 10px; overflow: hidden; border: 1px solid rgba(255, 255, 255, 0.1);">
                <div style="background: rgba(255, 255, 255, 0.05); padding: 1rem; border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
                    <h4 style="color: #FFD700; margin: 0;">Competition Entries</h4>
                </div>
                <div id="entriesTableContainer" style="max-height: 400px; overflow-y: auto;">
                    <div id="entriesTable" style="padding: 1rem;">
                        <p style="color: #ccc; text-align: center;">Loading entries...</p>
                    </div>
                </div>
            </div>

            <!-- Export Options -->
            <div style="margin-top: 1.5rem; text-align: center;">
                <button onclick="exportEntriesToCSV()" style="background: linear-gradient(90deg, #FFD700 0%, #FFB300 100%); color: #111; border: none; border-radius: 20px; padding: 10px 20px; cursor: pointer; margin-right: 1rem; font-weight: 600;">
                    <i class="fas fa-download"></i> Export to CSV
                </button>
                <button onclick="copyEntriesToClipboard()" style="background: rgba(255, 255, 255, 0.1); color: #fff; border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 20px; padding: 10px 20px; cursor: pointer; font-weight: 600;">
                    <i class="fas fa-copy"></i> Copy to Clipboard
                </button>
            </div>
        </div>

        <!-- Valid Codewords Management Section -->
        <div class="admin-section">
            <h2><i class="fas fa-key"></i> Valid Codewords Management</h2>
            <p style="color: #ccc; margin-bottom: 1rem;">Only entries with these codewords will be eligible for the draw.</p>
            
            <!-- Add New Codeword -->
            <div class="form-group">
                <label for="newCodeword">Add New Valid Codeword:</label>
                <div style="display: flex; gap: 1rem; align-items: end;">
                    <input type="text" id="newCodeword" placeholder="Enter codeword from video" style="flex: 1;">
                    <button class="add-video-btn" id="addCodewordBtn">Add Codeword</button>
                </div>
            </div>

            <!-- Valid Codewords List -->
            <div style="margin-top: 1.5rem;">
                <h4 style="color: #FFD700;">Valid Codewords: <span id="validCodewordCount">0</span></h4>
                <div id="validCodewordsList" style="max-height: 200px; overflow-y: auto; background: rgba(0,0,0,0.3); padding: 1rem; border-radius: 8px; font-size: 0.9rem;"></div>
            </div>

            <div class="success-message" id="codewordSuccess">Codeword updated successfully!</div>
            <div class="error-message" id="codewordError">Error updating codeword. Please try again.</div>
        </div>

        <!-- Subscriber Management Section -->
        <div class="admin-section">
            <h2><i class="fas fa-users"></i> Subscriber Management & Winner Selection</h2>
            
            <!-- YouTube Studio Link -->
            <div class="form-group">
                <label>Step 1: Export Subscribers from YouTube Studio</label>
                <div style="margin: 1rem 0;">
                    <a href="https://studio.youtube.com/channel/UCZ0DFo8W800exk9sTR7kUMQ/analytics/audience" target="_blank" class="save-btn" style="text-decoration: none; display: inline-block;">
                        <i class="fab fa-youtube"></i> Open YouTube Studio
                    </a>
                    <p style="color: #ccc; font-size: 0.9rem; margin-top: 0.5rem;">
                        Go to: Analytics â†’ Audience â†’ Export data â†’ Download CSV
                    </p>
                </div>
            </div>

            <!-- CSV Upload -->
            <div class="form-group">
                <label for="subscriberCSV">Step 2: Upload Subscriber CSV:</label>
                <input type="file" id="subscriberCSV" accept=".csv" onchange="handleSubscriberCSV(event)">
                <p style="color: #ccc; font-size: 0.9rem; margin-top: 0.5rem;">Upload the CSV file exported from YouTube Studio</p>
            </div>

            <!-- Competition Entries -->
            <div class="form-group">
                <label>Step 3: Competition Entries (Auto-loaded from Supabase):</label>
                <div style="background: rgba(0,255,0,0.1); padding: 1rem; border-radius: 8px; border: 1px solid rgba(0,255,0,0.3); margin-top: 0.5rem;">
                    <p style="color: #90EE90; margin: 0; font-weight: 600;">
                        <i class="fas fa-check-circle"></i> Competition entries are automatically loaded from your Supabase database
                    </p>
                    <p style="color: #ccc; font-size: 0.9rem; margin: 0.5rem 0 0 0;">
                        All entries submitted through your website form are automatically available here
                    </p>
                </div>
            </div>

            <!-- Manual Entry Addition -->
            <div class="form-group">
                <label>Step 4: Add Competition Entry Manually (Optional):</label>
                <p style="color: #ccc; font-size: 0.9rem; margin-bottom: 0.5rem;">Only use this if you need to add an entry that wasn't submitted through the website</p>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 0.5rem;">
                    <input type="text" id="entryName" placeholder="Full Name">
                    <input type="text" id="entryYoutube" placeholder="YouTube Name">
                    <input type="email" id="entryEmail" placeholder="Email">
                    <input type="text" id="entryCodeword" placeholder="Codeword">
                </div>
                <button class="add-video-btn" id="addManualEntryBtn" style="margin-top: 1rem;">Add Entry</button>
            </div>

            <!-- Data Display -->
            <div style="margin-top: 2rem;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                    <div>
                        <h4 style="color: #FFD700;">Subscribers Loaded: <span id="subscriberCount">0</span></h4>
                        <div id="subscriberList" style="max-height: 200px; overflow-y: auto; background: rgba(0,0,0,0.3); padding: 1rem; border-radius: 8px; font-size: 0.9rem;"></div>
                    </div>
                    <div>
                        <h4 style="color: #FFD700;">Competition Entries: <span id="entryCount">0</span></h4>
                        <div id="entryList" style="max-height: 200px; overflow-y: auto; background: rgba(0,0,0,0.3); padding: 1rem; border-radius: 8px; font-size: 0.9rem;"></div>
                    </div>
                </div>
            </div>

            <!-- Valid Entries -->
            <div style="margin-top: 2rem;">
                <h4 style="color: #90EE90;">Valid Entries (Subscribers): <span id="validEntryCount">0</span></h4>
                <div id="validEntryList" style="max-height: 200px; overflow-y: auto; background: rgba(0,255,0,0.1); padding: 1rem; border-radius: 8px; font-size: 0.9rem; border: 1px solid rgba(0,255,0,0.3);"></div>
            </div>

            <!-- Winner Selection -->
            <div style="margin-top: 2rem;">
                <button class="save-btn" onclick="pickRandomWinner()" style="background: linear-gradient(90deg, #FF6B6B 0%, #FF8E8E 100%);">
                    <i class="fas fa-random"></i> Pick Random Winner from Valid Entries
                </button>
                <div id="winnerResult" style="margin-top: 1rem; padding: 1rem; background: rgba(255,215,0,0.2); border-radius: 8px; border: 1px solid #FFD700; display: none;">
                    <h3 style="color: #FFD700; margin: 0;">ðŸŽ‰ WINNER SELECTED! ðŸŽ‰</h3>
                    <div id="winnerDetails" style="color: #fff; margin-top: 0.5rem;"></div>
                </div>
            </div>

            <!-- Previous Winners -->
            <div style="margin-top: 2rem;">
                <h4 style="color: #FFD700;">Previous Winners (Lifetime): <span id="previousWinnerCount">0</span></h4>
                <div id="previousWinnerList" style="max-height: 200px; overflow-y: auto; background: rgba(255,215,0,0.1); padding: 1rem; border-radius: 8px; border: 1px solid rgba(255,215,0,0.3); font-size: 0.9rem;"></div>
            </div>

            <div class="success-message" id="subscriberSuccess">Subscribers loaded successfully!</div>
            <div class="error-message" id="subscriberError">Error loading subscribers. Please try again.</div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Check authentication first
        function checkAuth() {
            const isLoggedIn = sessionStorage.getItem('adminLoggedIn');
            const loginTime = sessionStorage.getItem('loginTime');
            
            // Check if logged in and session is less than 8 hours old
            if (!isLoggedIn || !loginTime || (Date.now() - loginTime > 8 * 60 * 60 * 1000)) {
                // Clear any old session data
                sessionStorage.removeItem('adminLoggedIn');
                sessionStorage.removeItem('loginTime');
                
                // Redirect to login page
                window.location.href = 'admin-login.html';
                return false;
            }
            
            return true;
        }
        
        // Add logout function
        function logout() {
            sessionStorage.removeItem('adminLoggedIn');
            sessionStorage.removeItem('loginTime');
            window.location.href = 'admin-login.html';
        }
        
        // Check auth on page load
        if (!checkAuth()) {
            // Page will redirect, so stop execution
            console.log('Authentication failed, redirecting...');
            // Don't throw error as it prevents other functions from loading
        }
        
        // Initialize Supabase client
        const supabaseUrl = 'https://gstyydgnyenjzeeeqrse.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdzdHl5ZGdueWVuanplZWVxcnNlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM3NDUzOTAsImV4cCI6MjA2OTMyMTM5MH0.41mI_Fn-S6bptZjK20PjXIMeKy62ScHJftUT3ahdJQ4';
        const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

        // Global variables to store data
        let subscribers = [];
        let competitionEntries = [];
        let validEntries = [];
        let previousWinners = [];
        let validCodewords = []; // New: to store valid codewords
        let filteredEntries = []; // For search/filter functionality

        // Debug function - call this from console to test
        window.testAddCodeword = function() {
            console.log('ðŸ§ª Test function called - manually adding codeword');
            document.getElementById('newCodeword').value = 'TEST' + Math.random().toString(36).substr(2, 5);
            addValidCodeword();
        };

        // Load current values on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ðŸš€ Admin panel loading...');
            
            // Test basic console logging
            console.log('ðŸ”§ Testing console - if you see this, console is working');
            
            try {
                loadCurrentValues();
                loadCompetitionEntries();
                loadPreviousWinners();
                loadValidCodewords(); // Load valid codewords on page load
                setupEntriesSection(); // Setup the new entries overview section

                // Add event listeners after everything is loaded with error checking
                const updatePrizeImageBtn = document.getElementById('updatePrizeImageBtn');
                if (updatePrizeImageBtn) {
                    updatePrizeImageBtn.addEventListener('click', function() {
                        console.log('ðŸ”˜ Update Prize Image button clicked');
                        updatePrizeImage();
                    });
                    console.log('âœ… Prize Image button listener added');
                } else {
                    console.error('âŒ updatePrizeImageBtn not found');
                }
                
                const updatePrizeDescriptionBtn = document.getElementById('updatePrizeDescriptionBtn');
                if (updatePrizeDescriptionBtn) {
                    updatePrizeDescriptionBtn.addEventListener('click', function() {
                        console.log('ðŸ”˜ Update Prize Description button clicked');
                        updatePrizeDescription();
                    });
                    console.log('âœ… Prize Description button listener added');
                } else {
                    console.error('âŒ updatePrizeDescriptionBtn not found');
                }
                
                const updateVideosBtn = document.getElementById('updateVideosBtn');
                if (updateVideosBtn) {
                    updateVideosBtn.addEventListener('click', function() {
                        console.log('ðŸ”˜ Update Videos button clicked');
                        updateVideos();
                    });
                    console.log('âœ… Videos button listener added');
                } else {
                    console.error('âŒ updateVideosBtn not found');
                }
                
                const updateWinnerBtn = document.getElementById('updateWinnerBtn');
                if (updateWinnerBtn) {
                    updateWinnerBtn.addEventListener('click', function() {
                        console.log('ðŸ”˜ Update Winner button clicked');
                        updateWinner();
                    });
                    console.log('âœ… Winner button listener added');
                } else {
                    console.error('âŒ updateWinnerBtn not found');
                }
                
                const addCodewordBtn = document.getElementById('addCodewordBtn');
                if (addCodewordBtn) {
                    addCodewordBtn.addEventListener('click', function() {
                        console.log('ðŸ”˜ Add Codeword button clicked');
                        addValidCodeword();
                    });
                    console.log('âœ… Add Codeword button listener added');
                } else {
                    console.error('âŒ addCodewordBtn not found');
                }
                
                const addManualEntryBtn = document.getElementById('addManualEntryBtn');
                if (addManualEntryBtn) {
                    addManualEntryBtn.addEventListener('click', function() {
                        console.log('ðŸ”˜ Add Manual Entry button clicked');
                        addManualEntry();
                    });
                    console.log('âœ… Manual Entry button listener added');
                } else {
                    console.error('âŒ addManualEntryBtn not found');
                }
                
                // Add Enter key support for codeword input
                const newCodewordInput = document.getElementById('newCodeword');
                if (newCodewordInput) {
                    newCodewordInput.addEventListener('keypress', function(e) {
                        console.log('âŒ¨ï¸ Key pressed in codeword field:', e.key);
                        if (e.key === 'Enter') {
                            console.log('âŒ¨ï¸ Enter key detected - calling addValidCodeword');
                            e.preventDefault();
                            addValidCodeword();
                        }
                    });
                    console.log('âœ… Codeword input Enter key listener added');
                } else {
                    console.error('âŒ newCodeword input not found');
                }
                
                console.log('âœ… Admin panel loaded and event listeners attached');
            } catch (error) {
                console.error('ðŸ’¥ Error during admin panel initialization:', error);
            }
        });

        async function loadCompetitionEntries() {
            try {
                const { data, error } = await supabaseClient
                    .from('competition_entries')
                    .select('*')
                    .order('submittedat', { ascending: false });

                if (error) {
                    console.error('Error loading entries:', error);
                    return;
                }

                competitionEntries = data.map(entry => ({
                    name: `${entry.firstname} ${entry.lastname}`,
                    youtubeName: entry.youtubename,
                    email: entry.email,
                    codeword: entry.codeword,
                    submittedAt: entry.submittedat
                }));

                updateEntryDisplay();
                compareEntries();
                showSuccess('subscriberSuccess');
            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function loadPreviousWinners() {
            try {
                const { data, error } = await supabaseClient
                    .from('winners')
                    .select('*')
                    .order('wonat', { ascending: false });

                if (error) {
                    console.error('Error loading winners:', error);
                    return;
                }

                previousWinners = data;
                updatePreviousWinnerDisplay();
            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function loadValidCodewords() {
            try {
                const { data, error } = await supabaseClient
                    .from('valid_codewords')
                    .select('*');

                if (error) {
                    console.error('Error loading valid codewords:', error);
                    return;
                }

                validCodewords = data.map(cw => cw.codeword);
                updateValidCodewordDisplay();
            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function saveWinner(winner) {
            try {
                const { error } = await supabaseClient
                    .from('winners')
                    .insert([{
                        name: winner.name,
                        youtubename: winner.youtubeName,
                        email: winner.email,
                        codeword: winner.codeword,
                        wonat: new Date().toISOString()
                    }]);

                if (error) {
                    console.error('Error saving winner:', error);
                    return false;
                }

                return true;
            } catch (error) {
                console.error('Error:', error);
                return false;
            }
        }

        // Database helper functions
        async function saveConfigToDatabase(key, value) {
            const { data, error } = await supabaseClient
                .from('site_config')
                .upsert({ 
                    config_key: key, 
                    config_value: value,
                    updated_at: new Date().toISOString()
                }, {
                    onConflict: 'config_key'
                });
            
            if (error) {
                throw error;
            }
            return data;
        }

        async function loadConfigFromDatabase() {
            const { data, error } = await supabaseClient
                .from('site_config')
                .select('*');
            
            if (error) {
                console.error('Error loading config:', error);
                return {};
            }
            
            const config = {};
            data.forEach(row => {
                config[row.config_key] = row.config_value;
            });
            return config;
        }

        async function loadCurrentValues() {
            try {
                const config = await loadConfigFromDatabase();
                
                // Load current winner
                document.getElementById('winnerName').value = config.winner_name || 'John Doe';
                document.getElementById('winnerYoutube').value = config.winner_youtube || '@ScoobyBoi78';
                
                // Load current prize info
                document.getElementById('prizeImageUrl').value = config.prize_image_url || '';
                document.getElementById('prizeImageAlt').value = config.prize_image_alt || '';
                document.getElementById('prizeDescription').value = config.prize_description || '';
                
                // Load current videos
                if (config.featured_videos) {
                    try {
                        const videos = JSON.parse(config.featured_videos);
                        document.getElementById('video1').value = videos[0] || '';
                        document.getElementById('video2').value = videos[1] || '';
                        document.getElementById('video3').value = videos[2] || '';
                        
                        // Add additional video inputs if there are more than 3 videos
                        for (let i = 3; i < videos.length; i++) {
                            addVideoInput();
                            document.getElementById(`video${i + 1}`).value = videos[i];
                        }
                    } catch (error) {
                        console.error('Error parsing featured videos:', error);
                        // Use default videos
                        document.getElementById('video1').value = '4FWwHKRkwoU';
                        document.getElementById('video2').value = 'Zs877UXy5_g';
                        document.getElementById('video3').value = 'e5BjiDxgUVU';
                    }
                } else {
                    // Use default videos
                    document.getElementById('video1').value = '4FWwHKRkwoU';
                    document.getElementById('video2').value = 'Zs877UXy5_g';
                    document.getElementById('video3').value = 'e5BjiDxgUVU';
                }
                
                // Update preview if image URL exists
                if (config.prize_image_url) {
                    const preview = document.getElementById('prizeImagePreview');
                    preview.innerHTML = `<h4>Current Image:</h4><img src="${config.prize_image_url}" alt="${config.prize_image_alt || 'Current Prize'}">`;
                }
                
            } catch (error) {
                console.error('Error loading current values:', error);
                // Use defaults if database load fails
                document.getElementById('winnerName').value = 'John Doe';
                document.getElementById('winnerYoutube').value = '@ScoobyBoi78';
                document.getElementById('video1').value = '4FWwHKRkwoU';
                document.getElementById('video2').value = 'Zs877UXy5_g';
                document.getElementById('video3').value = 'e5BjiDxgUVU';
            }
        }

        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Check file size (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
                alert('File size must be less than 5MB');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                const imageUrl = e.target.result;
                
                // Update the URL field with the data URL
                document.getElementById('prizeImageUrl').value = imageUrl;
                
                // Update the preview
                const preview = document.getElementById('prizeImagePreview');
                preview.innerHTML = `<h4>Uploaded Image Preview:</h4><img src="${imageUrl}" alt="Uploaded Prize">`;
                
                // Auto-save the uploaded image to database
                try {
                    await saveConfigToDatabase('prize_image_url', imageUrl);
                    await saveConfigToDatabase('prize_image_alt', file.name);
                    showSuccess('prizeImageSuccess');
                } catch (error) {
                    console.error('Error saving uploaded image:', error);
                    showError('prizeImageError');
                }
            };
            
            reader.readAsDataURL(file);
        }

        function extractVideoId(url) {
            if (!url) return '';
            
            // If it's already just a video ID
            if (url.length === 11 && !url.includes('/') && !url.includes('=')) {
                return url;
            }
            
            // Extract from YouTube URL
            const regex = /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([^&\n?#]+)/;
            const match = url.match(regex);
            return match ? match[1] : url;
        }

        async function updatePrizeImage() {
            const imageUrl = document.getElementById('prizeImageUrl').value;
            const imageAlt = document.getElementById('prizeImageAlt').value;
            
            if (!imageUrl) {
                showError('prizeImageError');
                return;
            }
            
            try {
                // Save to database
                await saveConfigToDatabase('prize_image_url', imageUrl);
                await saveConfigToDatabase('prize_image_alt', imageAlt);
                
                // Update the preview
                const preview = document.getElementById('prizeImagePreview');
                preview.innerHTML = `<h4>New Image Preview:</h4><img src="${imageUrl}" alt="${imageAlt}">`;
                
                showSuccess('prizeImageSuccess');
            } catch (error) {
                console.error('Error saving prize image:', error);
                showError('prizeImageError');
            }
        }

        async function updatePrizeDescription() {
            const description = document.getElementById('prizeDescription').value;
            
            if (!description) {
                showError('prizeDescriptionError');
                return;
            }
            
            try {
                // Save to database
                await saveConfigToDatabase('prize_description', description);
                showSuccess('prizeDescriptionSuccess');
            } catch (error) {
                console.error('Error saving prize description:', error);
                showError('prizeDescriptionError');
            }
        }

        async function updateVideos() {
            const videoInputs = document.querySelectorAll('#videoInputs input');
            const videos = [];
            
            videoInputs.forEach(input => {
                const videoId = extractVideoId(input.value);
                if (videoId) {
                    videos.push(videoId);
                }
            });
            
            if (videos.length === 0) {
                showError('videosError');
                return;
            }
            
            // Ensure minimum of 3 videos for the main site
            if (videos.length < 3) {
                alert('Minimum 3 videos required for the main site. Please add more videos.');
                showError('videosError');
                return;
            }
            
            try {
                // Save to database
                await saveConfigToDatabase('featured_videos', JSON.stringify(videos));
                showSuccess('videosSuccess');
            } catch (error) {
                console.error('Error saving featured videos:', error);
                showError('videosError');
            }
        }

        async function updateWinner() {
            const name = document.getElementById('winnerName').value;
            const youtube = document.getElementById('winnerYoutube').value;
            
            if (!name || !youtube) {
                showError('winnerError');
                return;
            }
            
            try {
                // Save to database
                await saveConfigToDatabase('winner_name', name);
                await saveConfigToDatabase('winner_youtube', youtube);
                showSuccess('winnerSuccess');
            } catch (error) {
                console.error('Error saving winner:', error);
                showError('winnerError');
            }
        }

        async function addValidCodeword() {
            console.log('ðŸ”„ addValidCodeword function called');
            
            // Ensure validCodewords is initialized
            if (typeof validCodewords === 'undefined') {
                validCodewords = [];
            }
            
            const newCodeword = document.getElementById('newCodeword').value.trim();
            console.log('ðŸ“ Input value:', newCodeword);
            
            if (!newCodeword) {
                console.log('âŒ No codeword entered');
                alert('Please enter a codeword.');
                return;
            }

            if (validCodewords.includes(newCodeword)) {
                console.log('âŒ Codeword already exists');
                alert('This codeword is already in the list.');
                return;
            }

            try {
                console.log('ðŸ’¾ Attempting to save to database...');
                
                // Save to database first
                const { error } = await supabaseClient
                    .from('valid_codewords')
                    .insert([{ codeword: newCodeword }]);

                if (error) {
                    console.error('âŒ Database error:', error);
                    showError('codewordError');
                    return;
                }

                console.log('âœ… Database save successful');

                // Update local array and display
                validCodewords.push(newCodeword);
                updateValidCodewordDisplay();
                showSuccess('codewordSuccess');
                
                // Clear the input field
                document.getElementById('newCodeword').value = '';
                
                console.log('âœ… Codeword added successfully:', newCodeword);
                console.log('ðŸ“Š Current valid codewords:', validCodewords);
            } catch (error) {
                console.error('ðŸ’¥ Unexpected error adding codeword:', error);
                showError('codewordError');
            }
        }

        async function removeValidCodeword(codeword) {
            // Ensure validCodewords is initialized
            if (typeof validCodewords === 'undefined') {
                validCodewords = [];
            }
            
            const index = validCodewords.indexOf(codeword);
            if (index > -1) {
                try {
                    // Delete from database first
                    const { error } = await supabaseClient
                        .from('valid_codewords')
                        .delete()
                        .eq('codeword', codeword);

                    if (error) {
                        console.error('Error deleting codeword:', error);
                        showError('codewordError');
                        return;
                    }

                    // Update local array and display
                    validCodewords.splice(index, 1);
                    updateValidCodewordDisplay();
                    showSuccess('codewordSuccess');
                    
                    console.log('âœ… Codeword removed successfully:', codeword);
                } catch (error) {
                    console.error('Error removing codeword:', error);
                    showError('codewordError');
                }
            }
        }

        function updateValidCodewordDisplay() {
            // Ensure validCodewords is initialized
            if (typeof validCodewords === 'undefined') {
                validCodewords = [];
            }
            
            document.getElementById('validCodewordCount').textContent = validCodewords.length;
            const list = document.getElementById('validCodewordsList');
            list.innerHTML = ''; // Clear previous content

            if (validCodewords.length === 0) {
                list.innerHTML = '<p style="color: #ccc;">No valid codewords added yet.</p>';
                return;
            }

            validCodewords.forEach(codeword => {
                list.innerHTML += `<div style="margin-bottom: 0.5rem; padding: 0.5rem; background: rgba(255,255,255,0.1); border-radius: 4px; display: flex; justify-content: space-between; align-items: center;">
                    <span>${codeword}</span>
                    <button class="remove-video-btn" onclick="removeValidCodeword('${codeword}')"><i class="fas fa-times"></i></button>
                </div>`;
            });
            
            console.log('ðŸ“Š Valid codewords display updated:', validCodewords.length, 'codewords');
        }

        function addVideoInput() {
            const container = document.getElementById('videoInputs');
            const videoCount = container.children.length + 1;
            
            const newGroup = document.createElement('div');
            newGroup.className = 'video-input-group';
            newGroup.innerHTML = `
                <div class="form-group">
                    <label for="video${videoCount}">Video ${videoCount}:</label>
                    <input type="text" id="video${videoCount}" placeholder="https://www.youtube.com/watch?v=VIDEO_ID or just VIDEO_ID">
                </div>
                <button class="remove-video-btn" onclick="removeVideo(this)">Remove</button>
            `;
            
            container.appendChild(newGroup);
        }

        function removeVideo(button) {
            const container = document.getElementById('videoInputs');
            // Ensure minimum of 3 videos for the main site
            if (container.children.length > 3) {
                button.parentElement.remove();
            } else {
                alert('Minimum 3 videos required for the main site. Cannot remove more videos.');
            }
        }

        function showSuccess(elementId) {
            console.log('âœ… Showing success message for:', elementId);
            const element = document.getElementById(elementId);
            if (element) {
                element.style.display = 'block';
                console.log('âœ… Success message displayed');
                setTimeout(() => {
                    element.style.display = 'none';
                    console.log('âœ… Success message hidden');
                }, 3000);
            } else {
                console.error('âŒ Success element not found:', elementId);
            }
        }

        function showError(elementId) {
            console.log('âŒ Showing error message for:', elementId);
            const element = document.getElementById(elementId);
            if (element) {
                element.style.display = 'block';
                console.log('âŒ Error message displayed');
                setTimeout(() => {
                    element.style.display = 'none';
                    console.log('âŒ Error message hidden');
                }, 3000);
            } else {
                console.error('âŒ Error element not found:', elementId);
            }
        }

        function handleSubscriberCSV(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const csv = e.target.result;
                const lines = csv.split('\n');
                const headers = lines[0].split(',');
                
                subscribers = [];
                for (let i = 1; i < lines.length; i++) {
                    if (lines[i].trim()) {
                        const values = lines[i].split(',');
                        const subscriber = {
                            name: values[0]?.trim() || '',
                            youtubeName: values[1]?.trim() || '',
                            email: values[2]?.trim() || ''
                        };
                        subscribers.push(subscriber);
                    }
                }
                
                updateSubscriberDisplay();
                compareEntries();
                showSuccess('subscriberSuccess');
            };
            
            reader.readAsText(file);
        }

        function addManualEntry() {
            const name = document.getElementById('entryName').value;
            const youtubeName = document.getElementById('entryYoutube').value;
            const email = document.getElementById('entryEmail').value;
            const codeword = document.getElementById('entryCodeword').value;
            
            if (!name || !youtubeName || !email) {
                alert('Please fill in all required fields');
                return;
            }
            
            const entry = { name, youtubeName, email, codeword };
            competitionEntries.push(entry);
            
            // Clear form
            document.getElementById('entryName').value = '';
            document.getElementById('entryYoutube').value = '';
            document.getElementById('entryEmail').value = '';
            document.getElementById('entryCodeword').value = '';
            
            updateEntryDisplay();
            compareEntries();
            showSuccess('subscriberSuccess');
        }

        function updateSubscriberDisplay() {
            document.getElementById('subscriberCount').textContent = subscribers.length;
            const list = document.getElementById('subscriberList');
            
            if (subscribers.length === 0) {
                list.innerHTML = '<p style="color: #ccc;">No subscribers loaded</p>';
                return;
            }
            
            let html = '';
            subscribers.slice(0, 10).forEach(sub => {
                html += `<div style="margin-bottom: 0.5rem; padding: 0.5rem; background: rgba(255,255,255,0.1); border-radius: 4px;">
                    <strong>${sub.name}</strong><br>
                    <small>${sub.youtubeName}</small>
                </div>`;
            });
            
            if (subscribers.length > 10) {
                html += `<p style="color: #ccc; font-size: 0.8rem;">... and ${subscribers.length - 10} more</p>`;
            }
            
            list.innerHTML = html;
        }

        function updateEntryDisplay() {
            document.getElementById('entryCount').textContent = competitionEntries.length;
            const list = document.getElementById('entryList');
            
            if (competitionEntries.length === 0) {
                list.innerHTML = '<p style="color: #ccc;">No entries found in Supabase database</p>';
                return;
            }
            
            // Group entries by email to show multiple entries per person
            const entriesByEmail = {};
            competitionEntries.forEach(entry => {
                if (!entriesByEmail[entry.email]) {
                    entriesByEmail[entry.email] = [];
                }
                entriesByEmail[entry.email].push(entry);
            });
            
            let html = '';
            let displayCount = 0;
            const maxDisplay = 10;
            
            Object.entries(entriesByEmail).forEach(([email, entries]) => {
                if (displayCount >= maxDisplay) return;
                
                html += `<div style="margin-bottom: 0.5rem; padding: 0.5rem; background: rgba(255,255,255,0.1); border-radius: 4px;">
                    <strong>${entries[0].name}</strong> (${entries.length} entry${entries.length > 1 ? 'ies' : 'y'})<br>
                    <small>${entries[0].youtubeName} | ${email}</small><br>
                    <small style="color: #FFD700;">Codewords: ${entries.map(e => e.codeword).join(', ')}</small>
                </div>`;
                displayCount++;
            });
            
            const totalPeople = Object.keys(entriesByEmail).length;
            if (totalPeople > maxDisplay) {
                html += `<p style="color: #ccc; font-size: 0.8rem;">... and ${totalPeople - maxDisplay} more people</p>`;
            }
            
            list.innerHTML = html;
        }

        function compareEntries() {
            validEntries = [];
            
            competitionEntries.forEach(entry => {
                // Check if entry's YouTube name matches any subscriber
                const isSubscriber = subscribers.some(sub => 
                    sub.youtubeName.toLowerCase().includes(entry.youtubeName.toLowerCase()) ||
                    entry.youtubeName.toLowerCase().includes(sub.youtubeName.toLowerCase())
                );
                
                // Check if entry's codeword is valid
                const isValidCodeword = validCodewords.includes(entry.codeword);

                if (isSubscriber && isValidCodeword) {
                    validEntries.push(entry);
                }
            });
            
            updateValidEntryDisplay();
        }

        function updateValidEntryDisplay() {
            document.getElementById('validEntryCount').textContent = validEntries.length;
            const list = document.getElementById('validEntryList');
            
            if (validEntries.length === 0) {
                list.innerHTML = '<p style="color: #ccc;">No valid entries found. Make sure you have loaded subscribers and added valid codewords.</p>';
                return;
            }
            
            let html = '';
            validEntries.forEach(entry => {
                const isValidCodeword = validCodewords.includes(entry.codeword);
                const codewordStatus = isValidCodeword ? 
                    `<span style="color: #90EE90;">âœ“ Valid: ${entry.codeword}</span>` : 
                    `<span style="color: #FFB6C1;">âœ— Invalid: ${entry.codeword}</span>`;
                
                html += `<div style="margin-bottom: 0.5rem; padding: 0.5rem; background: rgba(0,255,0,0.2); border-radius: 4px; border: 1px solid rgba(0,255,0,0.3);">
                    <strong>${entry.name}</strong><br>
                    <small>${entry.youtubeName} | ${entry.email}</small><br>
                    <small>${codewordStatus}</small>
                </div>`;
            });
            
            list.innerHTML = html;
        }

        function updatePreviousWinnerDisplay() {
            document.getElementById('previousWinnerCount').textContent = previousWinners.length;
            const list = document.getElementById('previousWinnerList');

            if (previousWinners.length === 0) {
                list.innerHTML = '<p style="color: #ccc;">No previous winners found.</p>';
                return;
            }

            let html = '';
            previousWinners.slice(0, 10).forEach(winner => {
                html += `<div style="margin-bottom: 0.5rem; padding: 0.5rem; background: rgba(255,255,255,0.1); border-radius: 4px;">
                    <strong>${winner.name}</strong><br>
                    <small>${winner.youtubeName} | ${winner.email} (Codeword: ${winner.codeword})</small>
                </div>`;
            });

            if (previousWinners.length > 10) {
                html += `<p style="color: #ccc; font-size: 0.8rem;">... and ${previousWinners.length - 10} more</p>`;
            }

            list.innerHTML = html;
        }

        async function pickRandomWinner() {
            if (validEntries.length === 0) {
                alert('No valid entries found. Please load subscribers and competition entries first.');
                return;
            }
            
            // Filter out previous winners
            const eligibleEntries = validEntries.filter(entry => {
                return !previousWinners.some(winner => 
                    winner.email === entry.email || 
                    winner.youtubeName.toLowerCase() === entry.youtubeName.toLowerCase()
                );
            });
            
            if (eligibleEntries.length === 0) {
                alert('No eligible entries found. All valid entries have already won in previous competitions.');
                return;
            }
            
            // For fair selection, if someone has multiple entries, they get multiple chances
            // But we still select from individual entries, not people
            const randomIndex = Math.floor(Math.random() * eligibleEntries.length);
            const winner = eligibleEntries[randomIndex];
            
            // Update the winner display
            document.getElementById('winnerDetails').innerHTML = `
                <strong>Name:</strong> ${winner.name}<br>
                <strong>YouTube:</strong> ${winner.youtubeName}<br>
                <strong>Email:</strong> ${winner.email}<br>
                <strong>Codeword:</strong> ${winner.codeword}<br>
                <strong>Eligible Entries:</strong> ${eligibleEntries.length} out of ${validEntries.length} valid entries<br>
                <strong>Total People:</strong> ${new Set(eligibleEntries.map(e => e.email)).size} unique participants
            `;
            
            document.getElementById('winnerResult').style.display = 'block';
            
            // Auto-update the winner fields
            document.getElementById('winnerName').value = winner.name;
            document.getElementById('winnerYoutube').value = winner.youtubeName;
            
            // Save to database
            try {
                await saveConfigToDatabase('winner_name', winner.name);
                await saveConfigToDatabase('winner_youtube', winner.youtubeName);
            } catch (error) {
                console.error('Error saving winner to config:', error);
            }
            
            // Save winner to database
            saveWinner(winner).then(success => {
                if (success) {
                    showSuccess('winnerSuccess');
                    // Reload previous winners to update the list
                    loadPreviousWinners();
                } else {
                    showError('winnerError');
                }
            });
        }

        // ===== COMPETITION ENTRIES OVERVIEW FUNCTIONS =====

        function setupEntriesSection() {
            console.log('ðŸ”„ Setting up entries overview section...');
            
            // Add event listeners for search and filter
            const searchInput = document.getElementById('entrySearchInput');
            const codewordFilter = document.getElementById('codewordFilter');
            
            if (searchInput) {
                searchInput.addEventListener('input', filterEntries);
            }
            
            if (codewordFilter) {
                codewordFilter.addEventListener('change', filterEntries);
            }
            
            // Initial load of entries overview
            updateEntriesOverview();
        }

        function updateEntriesOverview() {
            console.log('ðŸ”„ Updating entries overview...');
            
            // Update statistics
            updateEntriesStatistics();
            
            // Update codeword filter options
            updateCodewordFilterOptions();
            
            // Update entries table
            filteredEntries = [...competitionEntries];
            displayEntriesTable();
        }

        function updateEntriesStatistics() {
            const totalEntries = competitionEntries.length;
            const uniqueParticipants = new Set(competitionEntries.map(entry => entry.email.toLowerCase())).size;
            const uniqueCodewords = new Set(competitionEntries.map(entry => entry.codeword)).size;
            
            document.getElementById('totalEntriesCount').textContent = totalEntries;
            document.getElementById('uniqueParticipantsCount').textContent = uniqueParticipants;
            document.getElementById('uniqueCodewordsCount').textContent = uniqueCodewords;
            
            console.log(`ðŸ“Š Statistics updated: ${totalEntries} entries, ${uniqueParticipants} participants, ${uniqueCodewords} codewords`);
        }

        function updateCodewordFilterOptions() {
            const codewordFilter = document.getElementById('codewordFilter');
            if (!codewordFilter) return;
            
            // Get unique codewords from entries
            const uniqueCodewords = [...new Set(competitionEntries.map(entry => entry.codeword))].sort();
            
            // Clear existing options (except "All Codewords")
            codewordFilter.innerHTML = '<option value="">All Codewords</option>';
            
            // Add codeword options
            uniqueCodewords.forEach(codeword => {
                const option = document.createElement('option');
                option.value = codeword;
                option.textContent = codeword;
                codewordFilter.appendChild(option);
            });
        }

        function filterEntries() {
            const searchTerm = document.getElementById('entrySearchInput').value.toLowerCase();
            const selectedCodeword = document.getElementById('codewordFilter').value;
            
            filteredEntries = competitionEntries.filter(entry => {
                const matchesSearch = !searchTerm || 
                    entry.name.toLowerCase().includes(searchTerm) ||
                    entry.email.toLowerCase().includes(searchTerm) ||
                    entry.codeword.toLowerCase().includes(searchTerm) ||
                    entry.youtubeName.toLowerCase().includes(searchTerm);
                
                const matchesCodeword = !selectedCodeword || entry.codeword === selectedCodeword;
                
                return matchesSearch && matchesCodeword;
            });
            
            displayEntriesTable();
        }

        function displayEntriesTable() {
            const tableContainer = document.getElementById('entriesTable');
            if (!tableContainer) return;
            
            if (filteredEntries.length === 0) {
                tableContainer.innerHTML = '<p style="color: #ccc; text-align: center;">No entries found matching your criteria.</p>';
                return;
            }
            
            // Group entries by email to show multiple entries per person
            const entriesByEmail = {};
            filteredEntries.forEach(entry => {
                if (!entriesByEmail[entry.email]) {
                    entriesByEmail[entry.email] = [];
                }
                entriesByEmail[entry.email].push(entry);
            });
            
            let html = '';
            
            // Create table header
            html += `
                <div style="display: grid; grid-template-columns: 2fr 1.5fr 1fr 1.5fr 1fr; gap: 1rem; padding: 0.75rem; background: rgba(255, 255, 255, 0.05); border-bottom: 1px solid rgba(255, 255, 255, 0.1); font-weight: 600; color: #FFD700;">
                    <div>Participant</div>
                    <div>YouTube Name</div>
                    <div>Entries</div>
                    <div>Codewords</div>
                    <div>Latest Entry</div>
                </div>
            `;
            
            // Sort by latest entry date
            const sortedEntries = Object.entries(entriesByEmail).sort((a, b) => {
                const latestA = Math.max(...a[1].map(entry => new Date(entry.submittedAt || 0).getTime()));
                const latestB = Math.max(...b[1].map(entry => new Date(entry.submittedAt || 0).getTime()));
                return latestB - latestA;
            });
            
            sortedEntries.forEach(([email, entries]) => {
                const latestEntry = entries.reduce((latest, entry) => {
                    return new Date(entry.submittedAt || 0) > new Date(latest.submittedAt || 0) ? entry : latest;
                });
                
                const codewords = [...new Set(entries.map(e => e.codeword))];
                const isValidParticipant = validCodewords.some(validCode => codewords.includes(validCode));
                
                const borderColor = isValidParticipant ? 'rgba(0, 255, 0, 0.3)' : 'rgba(255, 255, 255, 0.1)';
                const bgColor = isValidParticipant ? 'rgba(0, 255, 0, 0.05)' : 'rgba(255, 255, 255, 0.02)';
                
                html += `
                    <div style="display: grid; grid-template-columns: 2fr 1.5fr 1fr 1.5fr 1fr; gap: 1rem; padding: 0.75rem; border-bottom: 1px solid ${borderColor}; background: ${bgColor}; transition: all 0.3s ease;" onmouseover="this.style.background='rgba(255, 255, 255, 0.05)'" onmouseout="this.style.background='${bgColor}'">
                        <div>
                            <strong style="color: #fff;">${latestEntry.name}</strong><br>
                            <small style="color: #ccc;">${email}</small>
                            ${isValidParticipant ? '<br><span style="color: #90EE90; font-size: 0.8rem;"><i class="fas fa-check-circle"></i> Valid Entry</span>' : ''}
                        </div>
                        <div style="color: #FFD700;">${latestEntry.youtubeName}</div>
                        <div style="color: #00BFFF; font-weight: 600; font-size: 1.2rem;">${entries.length}</div>
                        <div style="color: #ccc; font-size: 0.9rem;">
                            ${codewords.map(cw => {
                                const isValid = validCodewords.includes(cw);
                                return `<span style="color: ${isValid ? '#90EE90' : '#FFB6C1'}; margin-right: 0.5rem;">${isValid ? 'âœ“' : 'âœ—'} ${cw}</span>`;
                            }).join('<br>')}
                        </div>
                        <div style="color: #ccc; font-size: 0.8rem;">
                            ${latestEntry.submittedAt ? new Date(latestEntry.submittedAt).toLocaleDateString() : 'Unknown'}
                        </div>
                    </div>
                `;
            });
            
            tableContainer.innerHTML = html;
            
            console.log(`ðŸ“‹ Displayed ${Object.keys(entriesByEmail).length} participants with ${filteredEntries.length} total entries`);
        }

        function refreshEntries() {
            console.log('ðŸ”„ Refreshing competition entries...');
            loadCompetitionEntries().then(() => {
                updateEntriesOverview();
                showSuccess('subscriberSuccess');
            });
        }

        function exportEntriesToCSV() {
            if (competitionEntries.length === 0) {
                alert('No entries to export.');
                return;
            }
            
            // Create CSV content
            const headers = ['Name', 'Email', 'YouTube Name', 'Codeword', 'Submitted At', 'Valid Entry'];
            const csvContent = [
                headers.join(','),
                ...competitionEntries.map(entry => {
                    const isValid = validCodewords.includes(entry.codeword);
                    return [
                        `"${entry.name}"`,
                        `"${entry.email}"`,
                        `"${entry.youtubeName}"`,
                        `"${entry.codeword}"`,
                        `"${entry.submittedAt || 'Unknown'}"`,
                        isValid ? 'Yes' : 'No'
                    ].join(',');
                })
            ].join('\n');
            
            // Create and download file
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `competition_entries_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            console.log('ðŸ“ CSV export completed');
        }

        function copyEntriesToClipboard() {
            if (competitionEntries.length === 0) {
                alert('No entries to copy.');
                return;
            }
            
            // Create formatted text
            const text = competitionEntries.map(entry => {
                const isValid = validCodewords.includes(entry.codeword) ? 'âœ“' : 'âœ—';
                return `${entry.name} (${entry.email}) - YouTube: ${entry.youtubeName} - Codeword: ${entry.codeword} ${isValid} - Submitted: ${entry.submittedAt || 'Unknown'}`;
            }).join('\n');
            
            // Copy to clipboard
            navigator.clipboard.writeText(text).then(() => {
                alert('Entries copied to clipboard!');
                console.log('ðŸ“‹ Entries copied to clipboard');
            }).catch(err => {
                console.error('Failed to copy to clipboard:', err);
                alert('Failed to copy to clipboard. Please try the CSV export instead.');
            });
        }

        // Override the existing loadCompetitionEntries function to also update the overview
        const originalLoadCompetitionEntries = loadCompetitionEntries;
        loadCompetitionEntries = async function() {
            await originalLoadCompetitionEntries();
            if (typeof updateEntriesOverview === 'function') {
                updateEntriesOverview();
            }
        };
    </script>
</body>
</html> 